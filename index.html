<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Warframe 1999 ‚Äî Dialog Route Guide</title>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.9/babel.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body, #root { height: 100%; }
body { background: #5a5a5a; color: #000; font-family: 'Tahoma', 'Arial', sans-serif; }

/* Windows XP style scrollbars */
::-webkit-scrollbar { width: 16px; }
::-webkit-scrollbar-track { background: #d4d0c8; border-top: 1px solid #808080; border-left: 1px solid #808080; }
::-webkit-scrollbar-thumb { background: #d4d0c8; border-top: 1px solid #fff; border-left: 1px solid #fff; border-right: 1px solid #808080; border-bottom: 1px solid #808080; }
::-webkit-scrollbar-thumb:hover { background: #c0bdb5; }
::-webkit-scrollbar-button { display: block; width: 16px; height: 16px; background: #d4d0c8; border-top: 1px solid #fff; border-left: 1px solid #fff; border-right: 1px solid #808080; border-bottom: 1px solid #808080; }

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.step-card { animation: fadeIn 0.25s ease-out both; }

/* KIM UI classes */
.kim-title-bar {
  background: linear-gradient(to right, #1a5f5f, #2d8080 35%, #2d8080 65%, #1a5f5f);
  padding: 2px 3px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  user-select: none;
  flex-shrink: 0;
}
.kim-title-btn {
  width: 16px;
  height: 14px;
  background: #d4d0c8;
  border-top: 1px solid #fff;
  border-left: 1px solid #fff;
  border-right: 1px solid #808080;
  border-bottom: 1px solid #808080;
  font-size: 9px;
  padding: 0;
  cursor: default;
  color: #000;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-family: inherit;
}
.kim-section-label {
  padding: 2px 8px;
  font-size: 9px;
  font-weight: 700;
  color: #555;
  letter-spacing: 1px;
  border-bottom: 1px solid #808080;
  background: #d4d0c8;
  text-transform: uppercase;
}
.kim-raised {
  border-top: 1px solid #fff;
  border-left: 1px solid #fff;
  border-right: 1px solid #808080;
  border-bottom: 1px solid #808080;
}
.kim-sunken {
  border-top: 1px solid #808080;
  border-left: 1px solid #808080;
  border-right: 1px solid #fff;
  border-bottom: 1px solid #fff;
}
.kim-btn {
  background: #d4d0c8;
  border-top: 1px solid #fff;
  border-left: 1px solid #fff;
  border-right: 1px solid #808080;
  border-bottom: 1px solid #808080;
  padding: 3px 10px;
  cursor: pointer;
  font-size: 11px;
  font-family: inherit;
}
.kim-btn:active {
  border-top: 1px solid #808080;
  border-left: 1px solid #808080;
  border-right: 1px solid #fff;
  border-bottom: 1px solid #fff;
}
.kim-input {
  border-top: 1px solid #808080;
  border-left: 1px solid #808080;
  border-right: 1px solid #fff;
  border-bottom: 1px solid #fff;
  background: #fff;
  padding: 2px 4px;
  font-family: inherit;
  font-size: 11px;
  outline: none;
  color: #000;
}

button { font-family: inherit; }
button:hover { filter: brightness(0.97); }

/* Mobile sidebar toggle */
@media (max-width: 768px) {
  .sidebar { position: fixed !important; left: -200px; z-index: 100; transition: left 0.25s ease; height: 100vh !important; }
  .sidebar.open { left: 0; }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; }
  .sidebar-overlay.open { display: block; }
  .mobile-toggle { display: flex !important; }
  .convo-panel { min-width: unset !important; width: 100% !important; border-right: none !important; max-height: 200px; }
  .main-layout { flex-direction: column !important; }
  .route-panel { padding: 8px 8px 60px !important; }
}
</style>
</head>
<body>
<div id="root"></div>
<script src="data.js" onerror="console.log('No local data.js found, using CORS proxy mode')"></script>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, useMemo } = React;

const BASE = "https://kim.browse.wf/flowcharts_svg/en/";
const CORS_PROXY = "https://corsproxy.io/?";
const LOCAL_DATA = window.WF1999_DATA || null;
const HAS_LOCAL = !!LOCAL_DATA;
const CHARACTERS = [
  { id: "Aoi", dir: "AoiDialogue_rom.dialogue", color: "#60a5fa", portrait: "‚ùÑÔ∏è" },
  { id: "Arthur", dir: "ArthurDialogue_rom.dialogue", color: "#f87171", portrait: "‚öîÔ∏è" },
  { id: "Eleanor", dir: "EleanorDialogue_rom.dialogue", color: "#c084fc", portrait: "üåô" },
  { id: "Flare", dir: "FlareDialogue_rom.dialogue", color: "#fb923c", portrait: "üî•" },
  { id: "Hex", dir: "HexDialogue_rom.dialogue", color: "#a78bfa", portrait: "üîÆ" },
  { id: "Jabir", dir: "JabirDialogue_rom.dialogue", color: "#34d399", portrait: "üß™" },
  { id: "Kaya", dir: "KayaDialogue_rom.dialogue", color: "#f472b6", portrait: "üéµ" },
  { id: "Lettie", dir: "LettieDialogue_rom.dialogue", color: "#fbbf24", portrait: "‚ú®" },
  { id: "Loid", dir: "LoidDialogue_rom.dialogue", color: "#94a3b8", portrait: "ü§ñ" },
  { id: "Lyon", dir: "LyonDialogue_rom.dialogue", color: "#2dd4bf", portrait: "üê∫" },
  { id: "Marie", dir: "MarieDialogue_rom.dialogue", color: "#e879f9", portrait: "üíú" },
  { id: "Minerva", dir: "MinervaDialogue_rom.dialogue", color: "#fca5a5", portrait: "ü¶Ö" },
  { id: "MinervaVelemir", dir: "MinervaVelemirDialogue_rom.dialogue", color: "#fca5a5", portrait: "ü¶Öüêª" },
  { id: "Quincy", dir: "QuincyDialogue_rom.dialogue", color: "#fb923c", portrait: "üéØ" },
  { id: "Roathe", dir: "RoatheDialogue_rom.dialogue", color: "#6ee7b7", portrait: "üåø" },
  { id: "Velemir", dir: "VelimirDialogue_rom.dialogue", color: "#a3a3a3", portrait: "üêª" },
];

/* ‚îÄ‚îÄ‚îÄ SVG PARSER ‚îÄ‚îÄ‚îÄ */
function parseSvg(svgText) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(svgText, "image/svg+xml");
  const nodes = {};
  const edges = [];

  doc.querySelectorAll("g.node").forEach((g) => {
    const title = g.querySelector("title")?.textContent?.trim();
    if (!title) return;
    const texts = [];
    g.querySelectorAll("text").forEach((t) => {
      const txt = t.textContent?.trim();
      if (txt) texts.push(txt);
    });
    const text = texts.join(" ").trim();
    const shape = g.querySelector("ellipse") || g.querySelector("polygon");
    const stroke = shape?.getAttribute("stroke") || "";
    let type = "dialog";
    if (stroke === "red") type = "choice";
    else if (stroke === "orange") type = "special";
    nodes[title] = { id: title, text, type, stroke };
  });

  doc.querySelectorAll("g.edge").forEach((g) => {
    const title = g.querySelector("title")?.textContent?.trim() || "";
    // Handle both raw -> and HTML-encoded &#45;>
    const cleaned = title.replace(/&#45;/g, "-").replace(/&#62;/g, ">");
    const m = cleaned.match(/^(.+?)-\>(.+)$/);
    if (!m) return;
    const from = m[1];
    const to = m[2];
    const path = g.querySelector("path");
    const edgeStroke = path?.getAttribute("stroke") || "black";
    let label = null;
    g.querySelectorAll("text").forEach((t) => {
      const val = t.textContent?.trim();
      if (val === "true" || val === "false") label = val;
    });
    edges.push({ from, to, stroke: edgeStroke, label });
  });

  return { nodes, edges };
}

/* ‚îÄ‚îÄ‚îÄ BEST PATH FINDER (DFS) ‚îÄ‚îÄ‚îÄ */
function extractChem(text) {
  const m = text?.match(/\+(\d+)\s*Chemistry/i);
  return m ? parseInt(m[1]) : 0;
}

function findBestPath(nodes, edges, startId) {
  const adj = {};
  for (const e of edges) {
    if (!adj[e.from]) adj[e.from] = [];
    adj[e.from].push(e);
  }

  let bestPath = null;
  let bestChem = -1;
  let iterations = 0;
  const MAX_ITER = 50000;

  function dfs(nodeId, path, chem, visited) {
    if (iterations++ > MAX_ITER) return;
    const node = nodes[nodeId];
    if (!node) return;

    // Prevent infinite loops but allow "Chat ends" revisits
    if (visited.has(nodeId) && !nodeId.includes("Chat ends")) return;

    const nodeChem = extractChem(node.text);
    const totalChem = chem + nodeChem;
    const newPath = [...path, { nodeId, text: node.text, type: node.type, chem: nodeChem }];

    const neighbors = adj[nodeId] || [];

    // Terminal conditions
    if (
      node.text?.includes("Chat ends") ||
      node.text?.match(/\[End\.?\]/) ||
      neighbors.length === 0
    ) {
      if (totalChem > bestChem) {
        bestChem = totalChem;
        bestPath = newPath;
      }
      return;
    }

    const newVisited = new Set(visited);
    newVisited.add(nodeId);

    for (const e of neighbors) {
      dfs(e.to, newPath, totalChem, newVisited);
    }
  }

  dfs(startId, [], 0, new Set());
  return { path: bestPath || [], totalChem: Math.max(0, bestChem) };
}

/* ‚îÄ‚îÄ‚îÄ ANALYZE A FLOWCHART SVG ‚îÄ‚îÄ‚îÄ */
function analyzeFlowchart(svgText) {
  const { nodes, edges } = parseSvg(svgText);
  const startNode = Object.keys(nodes).find((k) => k.includes("begins"));
  if (!startNode) return { steps: [], totalChem: 0 };

  const result = findBestPath(nodes, edges, startNode);

  // Build clean steps from the raw path
  const steps = [];
  for (const node of result.path) {
    if (
      node.text?.includes("Check boolean") ||
      node.text?.match(/^Boolean\s/) ||
      node.text?.includes("begins")
    ) continue;
    if (node.text === "Chat ends.") continue;

    if (node.type === "choice") {
      steps.push({ type: "choice", text: node.text, chem: node.chem });
    } else if (node.type === "special" && node.chem > 0) {
      steps.push({ type: "chem", text: node.text, chem: node.chem });
    } else if (node.type === "dialog") {
      steps.push({ type: "dialog", text: node.text, chem: node.chem });
    }
  }

  // Gather all alternatives at choice points
  const parentOfChoice = {};
  for (const e of edges) {
    const toNode = nodes[e.to];
    if (toNode?.type === "choice") {
      if (!parentOfChoice[e.from]) parentOfChoice[e.from] = [];
      parentOfChoice[e.from].push(toNode.text);
    }
  }
  // Also gather dialog siblings that are player-selectable
  for (const e of edges) {
    const fromNode = nodes[e.from];
    if (!fromNode) continue;
    const siblings = edges.filter(ee => ee.from === e.from);
    if (siblings.length > 1 && fromNode.type !== "special") {
      siblings.forEach(s => {
        const sn = nodes[s.to];
        if (sn?.type === "choice") {
          if (!parentOfChoice[e.from]) parentOfChoice[e.from] = [];
          if (!parentOfChoice[e.from].includes(sn.text)) parentOfChoice[e.from].push(sn.text);
        }
      });
    }
  }

  // Attach alternatives to choice steps
  const bestChoiceTexts = new Set(steps.filter(s => s.type === "choice").map(s => s.text));
  const enrichedSteps = steps.map((step, i) => {
    if (step.type !== "dialog") return step;
    // Find the next choice after this dialog
    const nextChoice = steps[i + 1];
    if (nextChoice?.type !== "choice") return step;
    // Find parent node
    const parentId = result.path.find(p => p.text === step.text)?.nodeId;
    if (!parentId) return step;
    const alts = (parentOfChoice[parentId] || []).filter(t => !bestChoiceTexts.has(t));
    // Calculate chemistry for each alternative branch so player can pick best available
    const enrichedAlts = alts.map(altText => {
      const altNodeId = Object.keys(nodes).find(k => nodes[k].text === altText);
      if (!altNodeId) return { text: altText, chem: null };
      const altResult = findBestPath(nodes, edges, altNodeId);
      return { text: altText, chem: altResult.totalChem };
    }).sort((a, b) => (b.chem ?? -1) - (a.chem ?? -1));
    return { ...step, alternatives: enrichedAlts };
  });

  return { steps: enrichedSteps, totalChem: result.totalChem };
}

/* ‚îÄ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ */
function normalizeSearch(s) {
  return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

function prettifyName(filename) {
  return filename.replace(/\.svg$/, "").replace(/([A-Z])/g, " $1").replace(/(\d+)/g, " $1 ").replace(/\s+/g, " ").trim();
}

function categorizeSvgs(files) {
  const ranks = {};
  const other = [];
  for (const f of files) {
    const m = f.match(/Rank(\d+)Convo(\d+)/);
    if (m) {
      const rank = parseInt(m[1]);
      if (!ranks[rank]) ranks[rank] = [];
      ranks[rank].push(f);
    } else {
      other.push(f);
    }
  }
  return { ranks, other };
}

/* ‚îÄ‚îÄ‚îÄ STATIC HELPERS (used during init before hooks) ‚îÄ‚îÄ‚îÄ */
function extractDialogTextStatic(svgText) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(svgText, "image/svg+xml");
  const lines = [];
  doc.querySelectorAll("g.node").forEach((g) => {
    const texts = [];
    g.querySelectorAll("text").forEach((t) => {
      const txt = t.textContent?.trim();
      if (txt) texts.push(txt);
    });
    const text = texts.join(" ").trim();
    if (text && !text.match(/^(Check boolean|Boolean )/)) lines.push(text);
  });
  return lines;
}

/* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
function App() {
  const [charIdx, setCharIdx] = useState(null);
  const [selectedFile, setSelectedFile] = useState(null);
  const [loading, setLoading] = useState(false);
  const [analysis, setAnalysis] = useState(null);
  const [error, setError] = useState(null);
  const [corsError, setCorsError] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [debouncedQuery, setDebouncedQuery] = useState("");
  const fileInputRef = useRef(null);
  const debounceRef = useRef(null);
  const [globalSearch, setGlobalSearch] = useState("");
  const [globalSearchDebounced, setGlobalSearchDebounced] = useState("");
  const globalDebounceRef = useRef(null);

  // Build initial cache from local data or localStorage
  const [cache, setCache] = useState(() => {
    if (HAS_LOCAL) {
      // Build full cache from bundled data.js ‚Äî instant, no network
      const c = {};
      for (const character of CHARACTERS) {
        const d = LOCAL_DATA[character.dir];
        if (!d) continue;
        const index = {};
        const indexLower = {};
        for (const [file, svgText] of Object.entries(d.svgs || {})) {
          const lines = extractDialogTextStatic(svgText);
          index[file] = lines;
          indexLower[file] = lines.map(normalizeSearch);
        }
        c[character.dir] = { files: d.files || [], svgs: d.svgs || {}, index, indexLower };
      }
      return c;
    }
    try {
      const saved = localStorage.getItem("wf1999_cache_v3");
      return saved ? JSON.parse(saved) : {};
    } catch { return {}; }
  });
  const cacheRef = useRef(cache);
  useEffect(() => { cacheRef.current = cache; }, [cache]);

  const [globalProgress, setGlobalProgress] = useState({ char: "", done: 0, total: 0 });
  const [isPreloading, setIsPreloading] = useState(false);

  const char = charIdx !== null ? CHARACTERS[charIdx] : null;
  const accentColor = char?.color || "#1a6060";
  const charCache = char ? cache[char.dir] : null;
  const convoFiles = charCache?.files || [];

  // Persist cache to localStorage (only in network mode)
  const saveTimerRef = useRef(null);
  useEffect(() => {
    if (HAS_LOCAL) return; // no need to cache, we have bundled data
    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
    saveTimerRef.current = setTimeout(() => {
      try { localStorage.setItem("wf1999_cache_v3", JSON.stringify(cache)); } catch {}
    }, 1000);
  }, [cache]);

  // Use the static helper
  const extractDialogText = extractDialogTextStatic;

  // Fetch file list for one character
  const fetchCharFiles = async (character) => {
    const url = CORS_PROXY + encodeURIComponent(BASE + character.dir + "/");
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const html = await res.text();
    const matches = [...html.matchAll(/href="([^"]*\.svg)"/gi)];
    return matches.map((m) => m[1]).sort();
  };

  // Preload ALL characters on mount (skip if local data bundled)
  useEffect(() => {
    if (HAS_LOCAL) return; // everything already loaded from data.js
    let cancelled = false;

    const isCharCached = (dir) => {
      const cc = cacheRef.current[dir];
      return cc?.files?.length > 0 && cc?.index && Object.keys(cc.index).length >= cc.files.length;
    };

    const indexOneCharacter = async (character) => {
      if (isCharCached(character.dir)) return;

      // 1. Get file list
      let files;
      const existing = cacheRef.current[character.dir];
      if (existing?.files?.length > 0) {
        files = existing.files;
      } else {
        files = await fetchCharFiles(character);
        if (files.length === 0) return;
        // Save file list immediately so UI can show it
        setCache(prev => {
          const next = { ...prev, [character.dir]: { ...prev[character.dir], files } };
          cacheRef.current = next;
          return next;
        });
      }

      // 2. Fetch all SVGs in parallel batches
      const idx = {};
      const idxLower = {};
      let done = 0;
      const BATCH = 12;

      for (let i = 0; i < files.length; i += BATCH) {
        if (cancelled) return;
        const batch = files.slice(i, i + BATCH);
        const results = await Promise.allSettled(
          batch.map(async (f) => {
            const url = CORS_PROXY + encodeURIComponent(BASE + character.dir + "/" + f);
            const r = await fetch(url);
            return { file: f, text: await r.text() };
          })
        );
        for (const r of results) {
          if (r.status === "fulfilled") {
            const lines = extractDialogText(r.value.text);
            idx[r.value.file] = lines;
            idxLower[r.value.file] = lines.map(normalizeSearch);
          }
        }
        done += batch.length;
        if (!cancelled) {
          setGlobalProgress({ char: character.id, done: Math.min(done, files.length), total: files.length });
        }
      }

      if (!cancelled) {
        setCache(prev => {
          const next = { ...prev, [character.dir]: { files, index: idx, indexLower: idxLower } };
          cacheRef.current = next;
          return next;
        });
      }
    };

    // Check if anything needs caching
    const needsCaching = CHARACTERS.some(c => !isCharCached(c.dir));
    if (!needsCaching) return;

    setIsPreloading(true);
    (async () => {
      for (const character of CHARACTERS) {
        if (cancelled) break;
        if (isCharCached(character.dir)) continue;
        setGlobalProgress({ char: character.id, done: 0, total: 0 });
        try {
          await indexOneCharacter(character);
        } catch {
          // Skip failed, continue with next
        }
      }
      if (!cancelled) setIsPreloading(false);
    })();

    return () => { cancelled = true; };
  }, []); // runs once on mount

  // Filtered file list based on search
  const getFilteredFiles = useCallback((files) => {
    if (!debouncedQuery.trim()) return null;
    const q = normalizeSearch(debouncedQuery);
    const lowerIndex = charCache?.indexLower;
    if (!lowerIndex) return null;
    return files.filter((f) => {
      if (prettifyName(f).toLowerCase().includes(q)) return true;
      const lines = lowerIndex[f] || [];
      return lines.some((line) => line.includes(q));
    });
  }, [debouncedQuery, charCache]);

  // Get matching lines for a file
  const getMatchingLines = useCallback((filename) => {
    if (!debouncedQuery.trim() || !charCache) return [];
    const q = normalizeSearch(debouncedQuery);
    const lines = charCache.index?.[filename] || [];
    const lowerLines = charCache.indexLower?.[filename] || [];
    const matches = [];
    for (let i = 0; i < lowerLines.length && matches.length < 2; i++) {
      if (lowerLines[i].includes(q)) matches.push(lines[i]);
    }
    return matches;
  }, [debouncedQuery, charCache]);

  // Fetch and analyze one SVG for route display
  const fetchAndAnalyze = useCallback(async (filename) => {
    if (!char) return;
    setLoading(true);
    setAnalysis(null);
    setError(null);
    try {
      let svgText;
      // Use local bundled SVG if available
      const localSvg = cache[char.dir]?.svgs?.[filename];
      if (localSvg) {
        svgText = localSvg;
      } else {
        const url = CORS_PROXY + encodeURIComponent(BASE + char.dir + "/" + filename);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        svgText = await res.text();
      }
      const result = analyzeFlowchart(svgText);
      setAnalysis(result);
    } catch (e) {
      setError("Failed to load: " + e.message);
    }
    setLoading(false);
  }, [char, cache]);

  // Manual upload handler
  const handleFileUpload = useCallback((e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const text = ev.target?.result;
      if (text) {
        setSelectedFile(file.name);
        setLoading(true);
        setTimeout(() => {
          try {
            setAnalysis(analyzeFlowchart(text));
            setError(null);
          } catch (err) {
            setError("Parse error: " + err.message);
          }
          setLoading(false);
        }, 50);
      }
    };
    reader.readAsText(file);
  }, []);

  // If selected character has no cached files and preloader isn't running, fetch file list
  useEffect(() => {
    if (HAS_LOCAL) return; // already have everything
    if (!char) return;
    if (charCache?.files?.length) return;
    if (isPreloading) return;
    setCorsError(false);
    fetchCharFiles(char).then(files => {
      if (files.length > 0) {
        setCache(prev => {
          const next = { ...prev, [char.dir]: { ...prev[char.dir], files } };
          cacheRef.current = next;
          return next;
        });
      }
    }).catch(() => setCorsError(true));
  }, [char, isPreloading]);

  // Debounce search input (150ms)
  useEffect(() => {
    if (debounceRef.current) clearTimeout(debounceRef.current);
    debounceRef.current = setTimeout(() => setDebouncedQuery(searchQuery), 150);
    return () => { if (debounceRef.current) clearTimeout(debounceRef.current); };
  }, [searchQuery]);

  // Debounce global search (200ms)
  useEffect(() => {
    if (globalDebounceRef.current) clearTimeout(globalDebounceRef.current);
    globalDebounceRef.current = setTimeout(() => setGlobalSearchDebounced(globalSearch), 200);
    return () => { if (globalDebounceRef.current) clearTimeout(globalDebounceRef.current); };
  }, [globalSearch]);

  // Global search across all characters
  const globalResults = useMemo(() => {
    if (!globalSearchDebounced.trim()) return null;
    const q = normalizeSearch(globalSearchDebounced);
    const results = [];
    for (const character of CHARACTERS) {
      const cc = cache[character.dir];
      if (!cc?.indexLower) continue;
      const matches = [];
      for (const file of (cc.files || [])) {
        const nameMatch = normalizeSearch(prettifyName(file)).includes(q);
        const lines = cc.indexLower[file] || [];
        const lineIdx = lines.findIndex(l => l.includes(q));
        if (nameMatch || lineIdx >= 0) {
          const snippet = lineIdx >= 0 ? cc.index[file][lineIdx] : null;
          matches.push({ file, snippet });
        }
      }
      if (matches.length > 0) results.push({ character, matches });
    }
    return results;
  }, [globalSearchDebounced, cache]);

  // Fetch and analyze a specific character's SVG (doesn't depend on char state)
  const fetchAndAnalyzeFor = useCallback(async (charDir, filename) => {
    setLoading(true);
    setAnalysis(null);
    setError(null);
    try {
      let svgText;
      const localSvg = cache[charDir]?.svgs?.[filename];
      if (localSvg) {
        svgText = localSvg;
      } else {
        const url = CORS_PROXY + encodeURIComponent(BASE + charDir + "/" + filename);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        svgText = await res.text();
      }
      setAnalysis(analyzeFlowchart(svgText));
    } catch (e) {
      setError("Failed to load: " + e.message);
    }
    setLoading(false);
  }, [cache]);

  const { ranks, other } = categorizeSvgs(convoFiles);

  return (
    <div style={{ display: "flex", flexDirection: "column", height: "100vh", padding: 2, background: "#5a5a5a", overflow: "hidden" }}>

      {/* KIM Title bar */}
      <div className="kim-title-bar">
        <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
          <span style={{ fontSize: 11, color: "#fff", fontWeight: 700, letterSpacing: 0.5, paddingLeft: 2 }}>
            üí¨ Welcome to KIM
          </span>
        </div>
        <div style={{ display: "flex", gap: 2 }}>
          <button className="kim-title-btn">‚Äì</button>
          <button className="kim-title-btn">‚ñ°</button>
          <button className="kim-title-btn">‚úï</button>
        </div>
      </div>

      {/* Window body */}
      <div style={{
        flex: 1, display: "flex", minHeight: 0,
        background: "#d4d0c8",
        borderTop: "1px solid #fff",
        borderLeft: "1px solid #fff",
        borderRight: "2px solid #404040",
        borderBottom: "2px solid #404040",
        overflow: "hidden",
      }}>

        {/* Mobile overlay */}
        <div className={`sidebar-overlay ${sidebarOpen ? "open" : ""}`} onClick={() => setSidebarOpen(false)} />

        {/* Sidebar / Left panel */}
        <aside className={`sidebar ${sidebarOpen ? "open" : ""}`} style={{
          width: 200, minWidth: 200,
          borderRight: "1px solid #808080",
          background: "#d4d0c8",
          display: "flex", flexDirection: "column", overflow: "hidden",
        }}>

          {/* User info section */}
          <div style={{
            padding: "6px 8px 5px",
            borderBottom: "1px solid #808080",
            background: "#d4d0c8",
          }}>
            <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 4 }}>
              <div style={{
                width: 32, height: 32, flexShrink: 0,
                background: "linear-gradient(135deg, #1a6060, #2d8080)",
                borderTop: "1px solid #fff", borderLeft: "1px solid #fff",
                borderRight: "1px solid #808080", borderBottom: "1px solid #808080",
                display: "flex", alignItems: "center", justifyContent: "center",
                fontSize: 16,
              }}>üõ°</div>
              <div>
                <div style={{ fontSize: 9, color: "#555", fontWeight: 700, letterSpacing: 0.5 }}>USERNAME:</div>
                <div style={{ fontSize: 11, fontWeight: 700, color: "#000" }}>Hyunatana</div>
              </div>
            </div>
            <div style={{ fontSize: 9, color: "#555" }}>
              <span style={{ display: "inline-block", width: 7, height: 7, borderRadius: "50%", background: "#ffa040", marginRight: 4, verticalAlign: "middle" }} />
              Online ¬∑ KIM v1.999
            </div>
          </div>

          {/* Global search bar */}
          <div style={{ padding: "4px 6px 3px", borderBottom: "1px solid #808080" }}>
            <div style={{ position: "relative" }}>
              <input
                type="text"
                placeholder="Find a contact..."
                value={globalSearch}
                onChange={e => setGlobalSearch(e.target.value)}
                className="kim-input"
                style={{ width: "100%", paddingLeft: 20, fontSize: 10 }}
              />
              <span style={{ position: "absolute", left: 4, top: "50%", transform: "translateY(-50%)", fontSize: 10, opacity: 0.5, pointerEvents: "none" }}>üîç</span>
              {globalSearch && (
                <button onClick={() => { setGlobalSearch(""); setGlobalSearchDebounced(""); }} style={{
                  position: "absolute", right: 2, top: "50%", transform: "translateY(-50%)",
                  background: "none", border: "none", color: "#555", cursor: "pointer", fontSize: 12, padding: 1,
                }}>√ó</button>
              )}
            </div>
            {globalSearchDebounced && globalResults !== null && (
              <div style={{ marginTop: 2, fontSize: 9, color: "#555" }}>
                {globalResults.length === 0
                  ? "No results found"
                  : `${globalResults.reduce((a, r) => a + r.matches.length, 0)} results ¬∑ ${globalResults.length} character${globalResults.length !== 1 ? "s" : ""}`}
              </div>
            )}
          </div>

          {/* BATCHES section label */}
          <div className="kim-section-label">BATCHES</div>

          {/* Character contact list */}
          <div style={{ flex: 1, overflowY: "auto" }}>
            {CHARACTERS.map((c, i) => {
              const active = charIdx === i;
              const isIndexed = !!cache[c.dir]?.index;
              const isLoading = isPreloading && globalProgress.char === c.id;
              return (
                <button key={c.id} onClick={() => {
                  setCharIdx(i); setSelectedFile(null); setAnalysis(null); setError(null); setCorsError(false); setSidebarOpen(false);
                  setSearchQuery(""); setDebouncedQuery("");
                }} style={{
                  display: "flex", alignItems: "center", gap: 6, width: "100%",
                  padding: "4px 8px", border: "none",
                  background: active ? "#1a6060" : "transparent",
                  color: active ? "#fff" : "#000",
                  cursor: "pointer", textAlign: "left",
                  borderBottom: "1px solid transparent",
                }}>
                  {/* Portrait square */}
                  <div style={{
                    width: 22, height: 22, flexShrink: 0,
                    background: active ? "#2d8080" : c.color + "33",
                    border: active ? "1px solid #3d9090" : "1px solid " + c.color + "66",
                    display: "flex", alignItems: "center", justifyContent: "center",
                    fontSize: 11, borderRadius: 1,
                  }}>{c.portrait}</div>
                  {/* Name + status */}
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{ fontSize: 11, fontWeight: 700, color: active ? "#fff" : "#000", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{c.id}</div>
                    <div style={{ fontSize: 9, color: active ? "#b0d8d8" : "#555", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                      {isLoading ? "Indexing..." : isIndexed ? "Ready to chat" : "Offline"}
                    </div>
                  </div>
                  {/* Online/offline dot */}
                  {isLoading ? (
                    <div style={{ width: 8, height: 8, border: `2px solid ${active ? "#3d9090" : "#1a6060"}44`, borderTopColor: active ? "#fff" : "#1a6060", borderRadius: "50%", animation: "spin 0.6s linear infinite", flexShrink: 0 }} />
                  ) : (
                    <span style={{ width: 8, height: 8, borderRadius: "50%", background: isIndexed ? "#ffa040" : "#909090", flexShrink: 0, display: "inline-block" }} />
                  )}
                </button>
              );
            })}
          </div>

          {/* Sidebar bottom section */}
          <div style={{ padding: "6px 8px", borderTop: "1px solid #808080", background: "#d4d0c8" }}>
            {HAS_LOCAL && (
              <div style={{
                marginBottom: 5, padding: "3px 6px",
                background: "#e8ffe8",
                borderTop: "1px solid #808080", borderLeft: "1px solid #808080",
                borderRight: "1px solid #fff", borderBottom: "1px solid #fff",
                fontSize: 9, color: "#006600",
              }}>
                ‚ö° Local data ¬∑ instant mode
              </div>
            )}
            {!HAS_LOCAL && isPreloading && (
              <div style={{
                marginBottom: 5, padding: "3px 6px",
                background: "#e8f0ff",
                borderTop: "1px solid #808080", borderLeft: "1px solid #808080",
                borderRight: "1px solid #fff", borderBottom: "1px solid #fff",
                fontSize: 9, color: "#003399", display: "flex", alignItems: "center", gap: 4,
              }}>
                <div style={{ width: 7, height: 7, border: "2px solid #003399", borderTopColor: "transparent", borderRadius: "50%", animation: "spin 0.6s linear infinite", flexShrink: 0 }} />
                Caching {globalProgress.char}... {globalProgress.done}/{globalProgress.total}
              </div>
            )}
            {!HAS_LOCAL && !isPreloading && Object.keys(cache).length > 0 && (
              <div style={{
                marginBottom: 5, padding: "3px 6px",
                background: "#e8ffe8",
                borderTop: "1px solid #808080", borderLeft: "1px solid #808080",
                borderRight: "1px solid #fff", borderBottom: "1px solid #fff",
                fontSize: 9, color: "#006600", display: "flex", justifyContent: "space-between", alignItems: "center",
              }}>
                <span>‚úì {Object.keys(cache).length}/{CHARACTERS.length} cached</span>
                <button onClick={() => { localStorage.removeItem("wf1999_cache_v3"); setCache({}); cacheRef.current = {}; location.reload(); }} style={{
                  background: "none", border: "none", color: "#555", cursor: "pointer", fontSize: 9, textDecoration: "underline", padding: 0,
                }}>Clear</button>
              </div>
            )}
            <input ref={fileInputRef} type="file" accept=".svg" onChange={handleFileUpload} style={{ display: "none" }} />
            <button onClick={() => fileInputRef.current?.click()} className="kim-btn" style={{ width: "100%", fontSize: 10, textAlign: "center" }}>
              üìÅ Upload SVG
            </button>
          </div>
        </aside>

        {/* Main content area */}
        <main style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden", background: "#d4d0c8" }}>

          {/* Mobile hamburger */}
          <button className="mobile-toggle" onClick={() => setSidebarOpen(true)} style={{
            display: "none", position: "fixed", top: 22, left: 10, zIndex: 98,
            width: 28, height: 22,
            background: "#d4d0c8",
            borderTop: "1px solid #fff", borderLeft: "1px solid #fff",
            borderRight: "1px solid #808080", borderBottom: "1px solid #808080",
            color: "#000", cursor: "pointer",
            alignItems: "center", justifyContent: "center", fontSize: 14,
          }}>‚ò∞</button>

          {globalSearchDebounced.trim() ? (
            /* ‚îÄ‚îÄ Global search results ‚îÄ‚îÄ */
            <div style={{ flex: 1, overflowY: "auto", padding: "8px 10px" }}>
              <div style={{
                padding: "3px 8px", marginBottom: 8,
                background: "#1a6060", color: "#fff",
                fontSize: 11, fontWeight: 700,
              }}>
                SEARCH RESULTS
                {globalResults && globalResults.length > 0
                  ? ` ‚Äî ${globalResults.reduce((a, r) => a + r.matches.length, 0)} results across ${globalResults.length} character${globalResults.length !== 1 ? "s" : ""}`
                  : ` ‚Äî No results for "${globalSearchDebounced}"`}
              </div>
              {globalResults && globalResults.map(({ character, matches }) => (
                <div key={character.id} style={{ marginBottom: 12 }}>
                  <div style={{
                    display: "flex", alignItems: "center", gap: 6,
                    padding: "2px 8px", marginBottom: 4,
                    background: "#1a6060", color: "#fff",
                    fontSize: 11, fontWeight: 700,
                  }}>
                    <span style={{ fontSize: 13 }}>{character.portrait}</span>
                    <span>{character.id}</span>
                    <span style={{ fontSize: 9, opacity: 0.8, marginLeft: "auto" }}>{matches.length} match{matches.length !== 1 ? "es" : ""}</span>
                  </div>
                  <div style={{ paddingLeft: 4 }}>
                    {matches.slice(0, 8).map(({ file, snippet }) => {
                      const q = globalSearchDebounced.toLowerCase();
                      const convoNum = file.match(/Convo(\d+)/)?.[1];
                      const label = convoNum ? `Conversation ${convoNum}` : prettifyName(file);
                      return (
                        <button key={file} onClick={() => {
                          const idx = CHARACTERS.findIndex(c => c.id === character.id);
                          setCharIdx(idx);
                          setSelectedFile(file);
                          setSearchQuery(""); setDebouncedQuery("");
                          setGlobalSearch(""); setGlobalSearchDebounced("");
                          fetchAndAnalyzeFor(character.dir, file);
                        }} className="kim-raised" style={{
                          display: "block", width: "100%", padding: "4px 8px", marginBottom: 2,
                          background: "#d4d0c8", textAlign: "left", cursor: "pointer", border: "none",
                          borderTop: "1px solid #fff", borderLeft: "1px solid #fff",
                          borderRight: "1px solid #808080", borderBottom: "1px solid #808080",
                        }}>
                          <div style={{ fontSize: 11, fontWeight: 700, color: "#1a6060" }}>{label}</div>
                          {snippet && (() => {
                            const idx = snippet.toLowerCase().indexOf(q);
                            const start = Math.max(0, idx - 30);
                            const raw = (start > 0 ? "‚Ä¶" : "") + snippet.slice(start, start + 80) + (start + 80 < snippet.length ? "‚Ä¶" : "");
                            const sIdx = raw.toLowerCase().indexOf(q);
                            return (
                              <div style={{ fontSize: 10, color: "#555", marginTop: 2, lineHeight: 1.4 }}>
                                "{sIdx >= 0 ? (
                                  <>{raw.slice(0, sIdx)}<span style={{ color: "#1a6060", fontWeight: 700 }}>{raw.slice(sIdx, sIdx + q.length)}</span>{raw.slice(sIdx + q.length)}</>
                                ) : raw}"
                              </div>
                            );
                          })()}
                        </button>
                      );
                    })}
                    {matches.length > 8 && (
                      <div style={{ fontSize: 9, color: "#555", padding: "2px 8px" }}>
                        +{matches.length - 8} more ‚Äî refine your search to narrow results
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          ) : !char ? (
            /* ‚îÄ‚îÄ No character selected: scanline wallpaper ‚îÄ‚îÄ */
            <div style={{
              flex: 1, display: "flex", alignItems: "center", justifyContent: "center",
              flexDirection: "column", gap: 12,
              background: "#606060",
              backgroundImage: "repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0,0,0,0.08) 1px, rgba(0,0,0,0.08) 2px)",
            }}>
              <div style={{ fontSize: 40 }}>üí¨</div>
              <div style={{
                fontSize: 13, fontWeight: 700, color: "#e0e0e0",
                letterSpacing: 3, textShadow: "0 1px 2px #000",
              }}>SELECT A CONTACT</div>
              <div style={{ fontSize: 10, color: "#a0a0a0", letterSpacing: 1 }}>KIM ‚Äî Karman Instant Messenger</div>
            </div>
          ) : (
            /* ‚îÄ‚îÄ Character view ‚îÄ‚îÄ */
            <div style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden" }}>

              {/* Character sub-title bar */}
              <div style={{
                background: "#1a6060",
                padding: "3px 10px",
                display: "flex", alignItems: "center", gap: 8,
                flexShrink: 0,
              }}>
                <div style={{
                  width: 20, height: 20,
                  background: accentColor + "44",
                  border: "1px solid " + accentColor,
                  display: "flex", alignItems: "center", justifyContent: "center",
                  fontSize: 11, flexShrink: 0,
                }}>{char.portrait}</div>
                <div style={{ fontSize: 12, fontWeight: 700, color: "#fff" }}>{char.id}</div>
                <div style={{ fontSize: 9, color: "#a0d8d8", marginLeft: "auto" }}>
                  {convoFiles.length > 0
                    ? `${convoFiles.length} conversations${charCache?.index ? " ¬∑ indexed" : ""}`
                    : corsError && !isPreloading
                      ? "Upload SVGs manually"
                      : isPreloading ? "Indexing..." : "Loading..."}
                </div>
              </div>

              {/* Warning / info banner */}
              {corsError && !isPreloading && convoFiles.length === 0 && (
                <div style={{
                  padding: "4px 10px",
                  background: "#ffffc0",
                  borderBottom: "1px solid #c0c000",
                  fontSize: 10, color: "#606000", lineHeight: 1.5,
                  flexShrink: 0,
                }}>
                  <strong>CORS Blocked</strong> ‚Äî Can't auto-fetch from kim.browse.wf.
                  {" "}Download SVGs from{" "}
                  <a href={BASE + char.dir + "/"} target="_blank" rel="noreferrer" style={{ color: "#1a6060" }}>kim.browse.wf</a>
                  {" "}and use the Upload SVG button.
                </div>
              )}

              <div className="main-layout" style={{ display: "flex", flex: 1, minHeight: 0 }}>

                {/* Conversation list panel */}
                <div className="convo-panel" style={{
                  width: 180, minWidth: 180,
                  borderRight: "1px solid #808080",
                  borderTop: "none",
                  overflowY: "auto",
                  background: "#d4d0c8",
                  display: "flex", flexDirection: "column",
                }}>

                  {/* Convo search */}
                  {convoFiles.length > 0 && (
                    <div style={{ padding: "4px 6px 3px", borderBottom: "1px solid #808080", flexShrink: 0 }}>
                      <div style={{ position: "relative" }}>
                        <input
                          type="text"
                          placeholder="Search dialog..."
                          value={searchQuery}
                          onChange={(e) => setSearchQuery(e.target.value)}
                          className="kim-input"
                          style={{ width: "100%", paddingLeft: 18, fontSize: 10 }}
                        />
                        <span style={{ position: "absolute", left: 3, top: "50%", transform: "translateY(-50%)", fontSize: 10, opacity: 0.5, pointerEvents: "none" }}>üîç</span>
                        {searchQuery && (
                          <button onClick={() => { setSearchQuery(""); setDebouncedQuery(""); }} style={{
                            position: "absolute", right: 2, top: "50%", transform: "translateY(-50%)",
                            background: "none", border: "none", color: "#555", cursor: "pointer", fontSize: 12, padding: 1,
                          }}>√ó</button>
                        )}
                      </div>
                      {isPreloading && globalProgress.char === char?.id && (
                        <div style={{ marginTop: 3, fontSize: 9, color: "#555", display: "flex", alignItems: "center", gap: 4 }}>
                          <div style={{ width: 8, height: 8, border: "2px solid #1a6060", borderTopColor: "transparent", borderRadius: "50%", animation: "spin 0.6s linear infinite", flexShrink: 0 }} />
                          Indexing {globalProgress.done}/{globalProgress.total}...
                        </div>
                      )}
                      {debouncedQuery && charCache?.index && (() => {
                        const filtered = getFilteredFiles(convoFiles);
                        return filtered ? (
                          <div style={{ marginTop: 2, fontSize: 9, color: "#555" }}>
                            {filtered.length} result{filtered.length !== 1 ? "s" : ""}
                          </div>
                        ) : null;
                      })()}
                    </div>
                  )}

                  <div style={{ flex: 1, overflowY: "auto" }}>
                    {!convoFiles.length && !corsError && !isPreloading && (
                      <div style={{ padding: 10, textAlign: "center", color: "#555", fontSize: 10 }}>Loading file list...</div>
                    )}
                    {!convoFiles.length && isPreloading && (
                      <div style={{ padding: 10, textAlign: "center", color: "#555", fontSize: 10, display: "flex", flexDirection: "column", alignItems: "center", gap: 6 }}>
                        <div style={{ width: 14, height: 14, border: "2px solid #1a6060", borderTopColor: "transparent", borderRadius: "50%", animation: "spin 0.6s linear infinite" }} />
                        Waiting for indexer...
                      </div>
                    )}

                    {(() => {
                      const filteredSet = getFilteredFiles(convoFiles);
                      const isSearching = debouncedQuery.trim().length > 0;
                      const filterFn = (f) => !filteredSet || filteredSet.includes(f);
                      const matchingLines = (f) => isSearching ? getMatchingLines(f) : [];

                      const renderConvoButton = (f) => {
                        const active = selectedFile === f;
                        const convoNum = f.match(/Convo(\d+)/)?.[1];
                        const matches = matchingLines(f);
                        const q = normalizeSearch(debouncedQuery);
                        return (
                          <button key={f} onClick={() => { setSelectedFile(f); fetchAndAnalyze(f); }} style={{
                            display: "block", width: "100%", padding: "4px 8px", marginBottom: 1,
                            border: "none", textAlign: "left", cursor: "pointer",
                            background: active ? "#1a6060" : "transparent",
                            color: active ? "#fff" : "#000",
                            fontSize: 11, fontWeight: active ? 700 : 400,
                          }}>
                            <div style={{ overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                              {convoNum ? `Conversation ${convoNum}` : prettifyName(f)}
                            </div>
                            {matches.map((line, mi) => {
                              const idx = line.toLowerCase().indexOf(q);
                              const start = Math.max(0, idx - 20);
                              const snippet = (start > 0 ? "‚Ä¶" : "") + line.slice(start, start + 50) + (start + 50 < line.length ? "‚Ä¶" : "");
                              const sIdx = snippet.toLowerCase().indexOf(q);
                              return (
                                <div key={mi} style={{ fontSize: 9, color: active ? "#b0d8d8" : "#555", marginTop: 1, lineHeight: 1.3, fontStyle: "italic" }}>
                                  "{sIdx >= 0 ? (
                                    <>{snippet.slice(0, sIdx)}<span style={{ color: active ? "#fff" : "#1a6060", fontWeight: 700, fontStyle: "normal" }}>{snippet.slice(sIdx, sIdx + q.length)}</span>{snippet.slice(sIdx + q.length)}</>
                                  ) : snippet}"
                                </div>
                              );
                            })}
                          </button>
                        );
                      };

                      return (
                        <>
                          {Object.entries(ranks).sort(([a],[b]) => a - b).map(([rank, files]) => {
                            const visibleFiles = files.sort().filter(filterFn);
                            if (visibleFiles.length === 0) return null;
                            return (
                              <div key={rank}>
                                <div className="kim-section-label">Rank {rank}</div>
                                {visibleFiles.map(renderConvoButton)}
                              </div>
                            );
                          })}
                          {(() => {
                            const visibleOther = other.sort().filter(filterFn);
                            if (visibleOther.length === 0) return null;
                            return (
                              <div>
                                <div className="kim-section-label">OTHER</div>
                                {visibleOther.map(renderConvoButton)}
                              </div>
                            );
                          })()}
                          {isSearching && filteredSet && filteredSet.length === 0 && (
                            <div style={{ padding: 10, textAlign: "center", color: "#555", fontSize: 10 }}>
                              No conversations match "{debouncedQuery}"
                            </div>
                          )}
                        </>
                      );
                    })()}
                  </div>
                </div>

                {/* Chat / Route display area */}
                <div className="route-panel" style={{ flex: 1, overflowY: "auto", padding: "8px 10px 40px", background: "#e8e4dc" }}>

                  {loading && (
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "center", padding: 40, flexDirection: "column", gap: 10 }}>
                      <div style={{ width: 20, height: 20, border: "2px solid #1a6060", borderTopColor: "transparent", borderRadius: "50%", animation: "spin 0.6s linear infinite" }} />
                      <div style={{ fontSize: 11, color: "#555" }}>Parsing flowchart...</div>
                    </div>
                  )}

                  {error && !loading && (
                    <div style={{
                      padding: "6px 10px",
                      background: "#ffffc0",
                      borderTop: "1px solid #808080", borderLeft: "1px solid #808080",
                      borderRight: "1px solid #fff", borderBottom: "1px solid #fff",
                      fontSize: 11, color: "#606000", lineHeight: 1.5,
                    }}>
                      ‚ö†Ô∏è {error}
                    </div>
                  )}

                  {!loading && !analysis && !error && (
                    <div style={{ flex: 1, display: "flex", alignItems: "center", justifyContent: "center", flexDirection: "column", gap: 8, opacity: 0.5, paddingTop: 60 }}>
                      <div style={{ fontSize: 28 }}>üí¨</div>
                      <div style={{ fontSize: 11, color: "#555", letterSpacing: 1 }}>
                        {corsError ? "UPLOAD AN SVG TO START" : "PICK A CONVERSATION"}
                      </div>
                    </div>
                  )}

                  {analysis && !loading && (
                    <>
                      {/* Route header */}
                      <div style={{
                        display: "flex", justifyContent: "space-between", alignItems: "center",
                        marginBottom: 8, paddingBottom: 6,
                        borderBottom: "1px solid #b0aca4",
                        flexWrap: "wrap", gap: 6,
                      }}>
                        <div>
                          <div style={{ fontSize: 12, fontWeight: 700, color: "#000" }}>
                            {prettifyName(selectedFile || "")}
                          </div>
                          <div style={{ fontSize: 9, color: "#555", marginTop: 1 }}>
                            {analysis.steps?.length || 0} steps ¬∑ optimal route
                          </div>
                        </div>
                        <div style={{
                          display: "flex", alignItems: "center", gap: 5,
                          padding: "4px 10px",
                          borderTop: "1px solid #fff", borderLeft: "1px solid #fff",
                          borderRight: "1px solid #808080", borderBottom: "1px solid #808080",
                          background: "#d4d0c8",
                        }}>
                          <span style={{ fontSize: 9, color: "#1a6060", fontFamily: "'Chakra Petch', monospace", fontWeight: 700 }}>MAX</span>
                          <span style={{ fontSize: 18, fontWeight: 700, color: "#1a6060", fontFamily: "'Chakra Petch', monospace" }}>
                            +{analysis.totalChem}
                          </span>
                          <span style={{ fontSize: 14 }}>‚öóÔ∏è</span>
                        </div>
                      </div>

                      {/* Steps / chat messages */}
                      {analysis.steps?.map((step, i) => {
                        const isChoice = step.type === "choice";
                        const isChem = step.type === "chem";

                        if (isChem) {
                          return (
                            <div key={i} className="step-card" style={{ animationDelay: `${i * 0.03}s`, display: "flex", alignItems: "center", gap: 8, padding: "4px 0 4px 8px", marginBottom: 4 }}>
                              <span style={{
                                display: "inline-flex", alignItems: "center", gap: 4,
                                background: "#1a6060",
                                color: "#fff", fontWeight: 700, fontSize: 11,
                                padding: "2px 10px",
                                borderTop: "1px solid #3d9090", borderLeft: "1px solid #3d9090",
                                borderRight: "1px solid #0a3030", borderBottom: "1px solid #0a3030",
                                fontFamily: "'Chakra Petch', monospace",
                              }}>
                                +{step.chem} Chemistry ‚öóÔ∏è
                              </span>
                            </div>
                          );
                        }

                        return (
                          <div key={i} className="step-card" style={{ animationDelay: `${i * 0.03}s`, marginBottom: 6 }}>
                            {isChoice ? (
                              /* Player choice bubble */
                              <div style={{ display: "flex", alignItems: "flex-start", gap: 6 }}>
                                <div style={{
                                  width: 22, height: 22, flexShrink: 0, marginTop: 1,
                                  background: "#1a6060",
                                  border: "1px solid #3d9090",
                                  display: "flex", alignItems: "center", justifyContent: "center",
                                  fontSize: 11,
                                }}>üõ°</div>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
                                    <span style={{
                                      background: "#1a6060", color: "#fff",
                                      fontSize: 9, fontWeight: 700,
                                      padding: "1px 6px",
                                      borderTop: "1px solid #3d9090", borderLeft: "1px solid #3d9090",
                                      borderRight: "1px solid #0a3030", borderBottom: "1px solid #0a3030",
                                    }}>PICK THIS</span>
                                    {step.chem > 0 && (
                                      <span style={{
                                        display: "inline-flex", alignItems: "center", gap: 2,
                                        color: "#1a6060", fontWeight: 700, fontSize: 10,
                                        fontFamily: "'Chakra Petch', monospace",
                                      }}>+{step.chem} ‚öóÔ∏è</span>
                                    )}
                                  </div>
                                  <div style={{
                                    padding: "4px 8px",
                                    background: "#fff",
                                    borderTop: "1px solid #808080", borderLeft: "1px solid #808080",
                                    borderRight: "1px solid #fff", borderBottom: "1px solid #fff",
                                    fontSize: 11, lineHeight: 1.5, color: "#1a6060", fontWeight: 700,
                                  }}>
                                    "{step.text}"
                                  </div>
                                </div>
                              </div>
                            ) : (
                              /* NPC dialog bubble */
                              <div style={{ display: "flex", alignItems: "flex-start", gap: 6 }}>
                                <div style={{
                                  width: 22, height: 22, flexShrink: 0, marginTop: 1,
                                  background: accentColor + "33",
                                  border: "1px solid " + accentColor + "66",
                                  display: "flex", alignItems: "center", justifyContent: "center",
                                  fontSize: 11,
                                }}>{char.portrait}</div>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 2 }}>
                                    <span style={{ fontSize: 10, fontWeight: 700, color: accentColor }}>{char.id.toUpperCase()}</span>
                                    {step.chem > 0 && (
                                      <span style={{
                                        display: "inline-flex", alignItems: "center", gap: 2,
                                        color: "#1a6060", fontWeight: 700, fontSize: 10,
                                        fontFamily: "'Chakra Petch', monospace",
                                      }}>+{step.chem} ‚öóÔ∏è</span>
                                    )}
                                  </div>
                                  <div style={{
                                    padding: "4px 8px",
                                    background: "#fff",
                                    borderTop: "1px solid #808080", borderLeft: "1px solid #808080",
                                    borderRight: "1px solid #fff", borderBottom: "1px solid #fff",
                                    fontSize: 11, lineHeight: 1.5, color: "#000",
                                  }}>
                                    "{step.text}"
                                  </div>
                                </div>
                              </div>
                            )}

                            {/* Alternatives panel */}
                            {step.alternatives?.length > 0 && (
                              <div style={{
                                marginTop: 4, marginLeft: 28, padding: "4px 8px",
                                background: "#d4d0c8",
                                borderTop: "1px solid #fff", borderLeft: "1px solid #fff",
                                borderRight: "1px solid #808080", borderBottom: "1px solid #808080",
                              }}>
                                <div style={{ fontSize: 9, fontWeight: 700, color: "#555", letterSpacing: 1, marginBottom: 3 }}>
                                  IF UNAVAILABLE, PICK IN ORDER:
                                </div>
                                {step.alternatives.map((alt, ai) => (
                                  <div key={ai} style={{
                                    display: "flex", justifyContent: "space-between", alignItems: "center",
                                    padding: "2px 6px", marginBottom: 2,
                                    background: "#e8e4dc",
                                    borderTop: "1px solid #808080", borderLeft: "1px solid #808080",
                                    borderRight: "1px solid #fff", borderBottom: "1px solid #fff",
                                  }}>
                                    <span style={{ fontSize: 10, color: "#333" }}>"{alt.text}"</span>
                                    {alt.chem !== null && (
                                      <span style={{
                                        fontSize: 9, color: "#1a6060", fontFamily: "'Chakra Petch', monospace",
                                        flexShrink: 0, marginLeft: 8, fontWeight: 700,
                                      }}>+{alt.chem} ‚öóÔ∏è</span>
                                    )}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        );
                      })}

                      {/* Total footer */}
                      <div style={{
                        textAlign: "center", padding: "10px 16px", marginTop: 10,
                        background: "#d4d0c8",
                        borderTop: "1px solid #fff", borderLeft: "1px solid #fff",
                        borderRight: "1px solid #808080", borderBottom: "1px solid #808080",
                      }}>
                        <div style={{ fontSize: 9, letterSpacing: 2, color: "#555", marginBottom: 2, fontWeight: 700 }}>TOTAL CHEMISTRY</div>
                        <div style={{
                          fontSize: 24, fontWeight: 700,
                          fontFamily: "'Chakra Petch', monospace",
                          color: "#1a6060",
                        }}>
                          +{analysis.totalChem} ‚öóÔ∏è
                        </div>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
          )}
        </main>
      </div>

      {/* Taskbar */}
      <div className="kim-title-bar" style={{ justifyContent: "space-between", padding: "2px 8px" }}>
        <span style={{ fontSize: 10, color: "#fff" }}>
          TO DO: {analysis && selectedFile
            ? `Viewing ${prettifyName(selectedFile)}`
            : char
              ? `Select a conversation for ${char.id}`
              : "Select a contact"}
        </span>
        <span style={{ fontSize: 10, color: "#b0d8d8" }}>April 11, 1999 üñ•</span>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
